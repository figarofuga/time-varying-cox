---
title: "How to analysis in R"
author: "Nozomi Niimi"
execute:
  echo: false
format:
  revealjs
---

## Introduction {.smaller}

-   生存分析において治療効果を定量化するときに最もよく使われるCox回帰分析
-   Cox回帰はその性質上、いくつかの過程が必要である
    -   比例ハザード性
    -   **治療効果はどの時点でも同じ**
    -   治療効果(関連)の線形性

## Cox proportional hazardの比例ハザード

## 

```{r}
#| label: setup
#| echo: false

library(tidyverse)
library(pammtools)
library(rstpm2)
library(survPen)
library(survival)
library(rms)
library(ggsurvfit)
library(survminer)
library(riskRegression)

```

## でも現実は

-   時間によって、関与する因子の情報が変わったりする
    -   時期によってタバコの本数が変わったり禁煙をしたり
-   因子が同じでも、時期によって関与の程度が変わる
    -   放射線曝露は若年者と高齢者で与える影響はおそらく変わる
-   どうする？

## time-varying covariates

1.  時間と共に値が変化する共変量
2.  時間とともに係数が変化する

## 1. 時間と共に値が変化する共変量

```{r}
#| label: testdata-prep

data(heart, package = "survival")

dat <- jasa |> 
  dplyr::mutate(
    futime = pmax(.5, fu.date - accept.dt), 
    txtime = as.numeric(if_else(tx.date == fu.date, 
                     (tx.date - accept.dt) -0.5, 
                     (tx.date - accept.dt))), 
    
    subject = dplyr::row_number()) |> 
  dplyr::rename(death_1 = fustat)

knitr::kable(head(dat, 5)) |> 
  kableExtra::kable_styling(font_size = 8,
                            latex_options = "scale_down")


```

## 列名の意味 {.smaller}

+---------------+----------------------------------------------------+
| Column name   | Meaning                                            |
+===============+====================================================+
| subject       | Patients' ID                                       |
+--------------------------------------------------------------------+|
| tx.date       | Transplant date                                    |
+---------------+----------------------------------------------------+
| futime        | Follow-up time                                     |
+---------------+----------------------------------------------------+
| age           | Age (in years)                                     |
+---------------+----------------------------------------------------+
| mismatch      | Mismatch score                                     |
+---------------+----------------------------------------------------+
| death_1       | Death or alive (1 indicate death)                  |
+---------------+----------------------------------------------------+
| tx.time       | Duration between registration and transplantation. |
+---------------+----------------------------------------------------+
| reject        | rejection occured                                  |
+---------------+----------------------------------------------------+

: Survival of patients on the waiting list for the Stanford heart transplant program.

## 通常の解析

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: simple-kmcurve

simple_fit <- survfit(Surv(futime, death_1) ~ transplant, data = dat)

survfit2(Surv(futime, death_1) ~ transplant, data = dat) |> 
  ggsurvfit(type = "risk") + 
  scale_color_discrete(labels = c("Not transplant", "Transplant")) +
  add_pvalue(location = "annotation") +
  add_risktable()

```
:::

::: {.column width="50%"}

```{r}
#| label: simple-coxanalysis

simple_fit <- survfit(Surv(futime, death_1) ~ transplant, data = dat)

coxph(Surv(futime, death_1) ~ transplant , data = dat) |> 
  gtsummary::tbl_regression(exponentiate = TRUE)

```

:::

::::

-   Transplantされた患者の予後が極めて良い

## この解析の問題は？

-   生き残った人しか移植を受けられない
    -   Lead time bias
        -   治療効果を過大に評価してしまう

## 他の例

-   悪性腫瘍の患者で、放射線曝露量と予後を見る
    -   途中で亡くなる患者は放射線療法を最後まで受けられない\n → 治療効果を過大に推定してしまう!!
    -   放射線の被曝量が多いほど予後が良い？ 
    → そのまま信じると危険！

## どうすればいい？
:::: {.columns}

::: {.column width="50%"}

![Idea of time-dependent analysis](images/time-dependent-idea.jpeg){fig-align="center"}

-   移植の待機中は非曝露期間として解析を行う

:::

::: {.column width="50%"}

![Idea of time-dependent analysis](images/transplant-split-idea.jpeg){fig-align="center"}

:::

::::

## 分割しても大丈夫？

![Idea of time-dependent analysis](images/time-split-idea.jpeg){fig-align="center"}

-   Cox回帰の性質上、ちゃんと比例ハザード性が保たれていれば問題はない！

## 実際の解析

:::: {.columns}

::: {.column width="50%"}

```{r}
#| label: data-info

colon_df <- survival::colon

knitr::kable(head(colon_df))

paste0("Number of patients: ", nrow(colon_df))

```

:::

::: {.column width="50%"}

```{r}
#| label: basic-coxph

survfit2(Surv(time, status) ~ surg, data = colon_df) |> 
  ggsurvfit(type = "risk") + 
  add_pvalue(location = "annotation") +
  add_risktable()

survival::coxph(Surv(time, status) ~ surg, data = colon_df) |> 
  gtsummary::tbl_regression(exponentiate = TRUE)

```

:::

-   テストデータ
-   比例ハザード性は保たれていそう

::::

## 分割した場合

:::: {.columns}

::: {.column width="50%"}

```{r}

colon_df2 <- survSplit(Surv(time, status) ~ ., colon_df,
                   cut=seq(0, 3500, by = 300), episode ="timegroup")

knitr::kable(head(colon_df2))

paste0("Number of patients: ", nrow(colon_df2))


```


:::

::: {.column width="50%"}

```{r}

survival::coxph(Surv(time, status) ~ surg, data = colon_df2) |> 
  gtsummary::tbl_regression(exponentiate = TRUE)


```

:::

::::


## 実際の解析

```{r}

#| label: time-varying-covariate-dataframe

# Create time-varying covariate

tdata <- dplyr::select(dat, subject, futime, txtime, death_1)

xdata <- tmerge(dat, tdata, id=subject,
death = event(futime, death_1),
transplant = tdc(txtime),
options= list(idname="subject"))

sdata <- tmerge(dat, tdata, id=subject,
death = event(futime, death_1),
trt = tdc(txtime),
options= list(idname="subject")) |> 
  dplyr::mutate(age = age - 48, 
                year = as.numeric(accept.dt - as.Date("1967-10-01"))/365.25)

time_depedent_fit <- coxph(Surv(tstart, tstop, death) ~ trt,
data= sdata, ties="breslow")

finalfit::fit2df(time_depedent_fit)
# Fit Cox proportional hazards model

```

```{r}
#| label: time-varying-coefficient

options(show.signif.stars = FALSE)

vfit <- coxph(Surv(time, status) ~ trt + prior + karno, data = veteran)

quantile(veteran$karno)

zp <- cox.zph(vfit, transform = function(time)log(time + 20))

survminer::ggcoxzph(zp, var = "karno") |> ggpubr::ggpar(ylim = c(-0.12, 0.04))

vet2 <- survSplit(Surv(time, status) ~ ., data = veteran, cut = c(90, 180), episode = "tgroup", id = "id")

knitr::kable(head(dplyr::select(vet2, id, tstart, time, status, tgroup, age, karno))) |> 
  kableExtra::kable_styling(latex_options = "scale_down")


vfit2 <- coxph(Surv(tstart, time, status) ~ trt + prior +
karno:strata(tgroup), data=vet2)


```
