---
title: "How to analysis in R"
author: "Nozomi Niimi"
execute:
  echo: true
format:
  revealjs:
    smaller: true
---

## Introduction

-   生存分析において治療効果を定量化するときに最もよく使われるCox回帰分析
-   Cox回帰はその性質上、いくつかの過程が必要である
    -   比例ハザード性
    -   **治療効果はどの時点でも同じ**
    -   治療効果(関連)の線形性

## Cox proportional hazardの比例ハザード

## 

```{r}
library(tidyverse)
library(pammtools)
library(rstmp2)
library(survPen)
library(survival)
library(rms)
library(ggsurvfit)
library(riskRegression)

dat <- data(heart, package = "survival")
```

## でも現実は

-   時間によって、関与する因子の情報が変わったりする
    -   時期によってタバコの本数が変わったり禁煙をしたり
-   因子が同じでも、時期によって関与の程度が変わる
    -   放射線曝露は若年者と高齢者で与える影響はおそらく変わる
-   どうする？

## 簡単な解決方法

-   細かく時間を区切って分ける
-   例

## time-varying covariates

-   実は2種類存在する

1.  時間と共に値が変化する共変量
2.  時間とともに係数が変化する

## 時間と共に値が変化する共変量

```{r}

data(heart, package = "survival")

knitr::kable(head(jasa, 5)) |> 
  kableExtra::kable_styling(font_size = 8,
                            latex_options = "scale_down")


```

## 列名の意味

-   

-   

## 通常の解析

```{r}

simple_fit <- survfit(Surv(futime, fustat) ~ transplant, data = jasa)

survfit2(Surv(futime, fustat) ~ transplant, data = jasa) |> 
  ggsurvfit(type = "risk") + 
  add_pvalue(location = "annotation") +
  add_risktable()

coxph(Surv(futime, fustat) ~ transplant, data = jasa) |> 
  gtsummary::tbl_regression(exponentiate = TRUE)

```

## この解析の問題は？

-   生き残った人しか移植を受けられない
    -   Lead time bias
-   他の例: 悪性腫瘍の患者で、放射線曝露量と予後を見る
    -   途中で亡くなる患者は放射線療法を最後まで受けられない\n → 治療効果を過大に推定してしまう!!

## どうすればいい？

\[絵を入れる\] \* 移植の待機中は非曝露期間として解析を行う

## 実際

```{r}


# Create time-varying covariate
heart_tv <- survSplit(Surv(heart$start, heart$stop, heart$event) ~ ., data = heart, cut = 365)

# Merge time-varying covariate with original dataset
heart_tv <- merge(heart, heart_tv, all.x = TRUE)

# Fit Cox proportional hazards model
cox_model <- coxph(Surv(start, stop, event) ~ age + sex + transplant + surgery + year + imonth + iday + transplant:tstart, data = heart_tv)

# Obtain model summary
summary(cox_model)

```

